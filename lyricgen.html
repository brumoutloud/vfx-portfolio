<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyricGen App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- GSAP CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1e26 0%, #11141a 100%); /* Subtle dark gradient background */
            display: flex;
            flex-direction: column; /* Allow vertical stacking of header and app-card */
            justify-content: flex-start; /* Align content from the top */
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px; /* More vertical padding for the whole page */
            box-sizing: border-box;
            color: #e2e8f0;
            overflow-y: auto; /* Allow body to scroll if content exceeds viewport */
        }

        .hero-section {
            text-align: center;
            margin-bottom: 3.5rem; /* Space between hero and app card */
            color: #e2e8f0;
            /* Removed opacity: 0 and transform: translateY(20px) from CSS */
        }
        .hero-section h1 {
            font-size: 3.5rem; /* Very large hero text */
            font-weight: 800;
            letter-spacing: -0.05em; /* Tighter for a punchier headline */
            line-height: 1.1;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .hero-section p {
            font-size: 1.15rem;
            margin-top: 0.8rem;
            color: #a0aec0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .app-card {
            background-color: #20242e; /* The floating card background */
            border-radius: 1rem; /* Overall card border radius */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 5px 15px rgba(0, 0, 0, 0.3); /* Deeper, softer shadow */
            max-width: 950px; /* Wider card */
            width: 100%;
            padding: 3rem; /* Generous padding inside the card */
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Increased gap between sections within the card */
            position: relative;
            overflow: hidden; /* Crucial for mode transitions */
            transform: translateZ(0); /* Force hardware acceleration */
            border: 1px solid rgba(255, 255, 255, 0.05); /* Subtle border for definition */
            /* Removed opacity: 0 and transform: translateY(20px) from CSS */
        }

        h2 {
            font-weight: 800;
            letter-spacing: -0.04em;
            color: #e2e8f0;
            text-shadow: 0 3px 6px rgba(0,0,0,0.4);
            font-size: 2.2rem; /* Slightly smaller than hero, for internal card headings */
            margin-bottom: 1.5rem;
        }
        label {
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: block;
            color: #a0aec0;
            font-size: 0.95rem;
            letter-spacing: 0.01em;
        }
        input, textarea, select {
            background-color: rgba(62, 72, 93, 0.6);
            border: 1px solid rgba(102, 126, 234, 0.4);
            color: #e2e8f0;
            padding: 1rem 1.4rem;
            border-radius: 0.75rem;
            outline: none;
            transition: border-color 0.4s ease-in-out, box-shadow 0.4s ease-in-out, background-color 0.4s ease-in-out;
            resize: vertical;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.3);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: relative;
        }
        select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23a0aec0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #7f9cf5;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.4), inset 0 3px 6px rgba(0, 0, 0, 0.4);
            background-color: rgba(52, 62, 80, 0.7);
        }
        button {
            background: linear-gradient(90deg, #667eea, #7f9cf5);
            color: white;
            padding: 1.1rem 2rem;
            border-radius: 0.85rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 3px 6px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translateZ(0);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        button:hover {
            background: linear-gradient(90deg, #5a67d8, #667eea);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
            margin-left: 1rem;
            opacity: 0;
            transform: scale(0);
            flex-shrink: 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #fbd38d;
            background-color: rgba(237, 137, 54, 0.25);
            border: 1px solid #ed8936;
            padding: 0.9rem 1.2rem;
            border-radius: 0.6rem;
            margin-top: 1.2rem;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: 600;
        }
        .output-section {
            background-color: rgba(46, 56, 75, 0.8);
            backdrop-filter: blur(15px);
            padding: 2rem;
            border-radius: 1rem; /* Slightly smaller for the output card */
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            border: 1px solid rgba(102, 126, 234, 0.15);
        }
        .output-section textarea {
            min-height: 280px;
            max-height: 500px;
            background-color: rgba(30, 38, 51, 0.7);
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
            padding: 1.2rem;
            border-radius: 0.85rem;
            line-height: 1.6;
        }
        .output-section h3 {
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        /* Mode Specific Styling */
        .form-wrapper {
            position: relative; /* Container for absolute positioned mode sections */
            width: 100%;
            /* min-height will be set dynamically by JS to manage transitions */
        }
        .mode-section {
            width: 100%;
            transition: none; /* GSAP handles transforms and opacity */
            position: absolute;
            top: 0;
            left: 0;
            padding: 0; /* Padding is handled by .app-card for top level */
            box-sizing: border-box;
            background-color: transparent; /* Transparent, app-card has background */
            height: auto; /* Allow height to adjust to content */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            perspective: 1000px; /* For 3D transform */
            transform-origin: center center; /* Ensure consistent origin for rotation */
        }
        #simpleModeSection {
            transform: translateX(0%) rotateY(0deg);
            opacity: 1;
            z-index: 2;
        }
        #customModeSection {
            transform: translateX(100%) rotateY(-90deg); /* Start off-screen and rotated */
            opacity: 0;
            z-index: 1;
            pointer-events: none;
        }
        #outputSection {
            position: static; /* Output section remains in normal flow */
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .app-card {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 3rem;
                padding: 3rem;
            }
            .form-wrapper {
                grid-column: 1;
                position: relative;
                min-height: 700px; /* Ensure enough height for transitions */
            }
            .output-section {
                grid-column: 2;
                display: flex;
                flex-direction: column;
                gap: 1.2rem;
            }
            .full-width {
                grid-column: span 2;
            }
            .input-group {
                margin-bottom: 1.2rem;
            }

            .mode-section {
                padding: 0; /* Reset padding for grid item context */
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%; /* Fill form-wrapper height */
                gap: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="hero-section" id="heroSection">
        <h1>Generate Your Next Lyric</h1>
        <p>12,223 lyrics generated so far.</p>
    </div>

    <div class="app-card" id="appCard">
        <div class="form-wrapper" id="formWrapper">
            <!-- Simple Mode Section -->
            <div class="mode-section" id="simpleModeSection">
                <h2 class="text-3xl font-bold text-center mb-6 text-white">Simple Lyric Mode</h2>

                <div class="input-group mb-4">
                    <label for="songThemeSimple">1. Song Theme / Concept <span class="text-red-400">*</span></label>
                    <input type="text" id="songThemeSimple" placeholder="e.g., Rediscovering old memories, A journey through a futuristic city">
                </div>

                <div class="input-group mb-4">
                    <label for="targetPlatformSimple">2. Target Platform <span class="text-red-400">*</span></label>
                    <select id="targetPlatformSimple" class="w-full">
                        <option value="suno">Suno AI</option>
                        <option value="general">General Lyrics</option>
                    </select>
                </div>

                <div class="input-group mb-4">
                    <label for="musicalStyleSimple">3. Musical Style / Genre <span class="text-red-400">*</span></label>
                    <select id="musicalStyleSimple" class="w-full">
                        <option value="">Select a genre</option>
                        <option value="Pop">Pop</option>
                        <option value="Rock">Rock</option>
                        <option value="Hip Hop">Hip Hop</option>
                        <option value="R&B">R&B</option>
                        <option value="Electronic">Electronic</option>
                        <option value="Country">Country</option>
                        <option value="Folk">Folk</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Classical">Classical</soption>
                        <option value="Blues">Blues</option>
                        <option value="Indie">Indie</option>
                        <option value="Alternative">Alternative</option>
                        <option value="Lo-fi">Lo-fi</soption>
                        <option value="Metal">Metal</soption>
                        <option value="Reggae">Reggae</option>
                        <option value="Other">Other...</option>
                    </select>
                    <input type="text" id="musicalStyleOtherSimple" class="mt-2 w-full hidden" placeholder="Enter custom genre">
                </div>

                <div class="input-group mb-6">
                    <label for="toneMoodSimple">4. Tone / Mood <span class="text-red-400">*</span></label>
                    <select id="toneMoodSimple" class="w-full">
                        <option value="">Select a tone/mood</option>
                        <option value="Melancholic">Melancholic</option>
                        <option value="Uplifting">Uplifting</option>
                        <option value="Reflective">Reflective</option>
                        <option value="Energetic">Energetic</option>
                        <option value="Calm">Calm</soption>
                        <option value="Mysterious">Mysterious</option>
                        <option value="Aggressive">Aggressive</option>
                        <option value="Playful">Playful</option>
                        <option value="Romantic">Romantic</option>
                        <option value="Hopeful">Hopeful</option>
                        <option value="Dark">Dark</option>
                        <option value="Other">Other...</option>
                    </select>
                    <input type="text" id="toneMoodOtherSimple" class="mt-2 w-full hidden" placeholder="Enter custom tone/mood">
                </div>

                <div id="errorMessageSimple" class="error-message"></div>

                <button id="generateButtonSimple" class="w-full">
                    <span>Generate Lyrics</span>
                    <div class="loading-spinner"></div>
                </button>
                <button id="goToCustomModeButton" class="w-full mt-4 bg-gray-600 hover:bg-gray-700">Go to Custom Mode</button>
            </div>

            <!-- Custom Mode Section -->
            <div class="mode-section" id="customModeSection">
                <h2 class="text-3xl font-bold text-center mb-6 text-white">Custom Lyric Settings</h2>

                <div class="input-group mb-4">
                    <label for="songThemeCustom">1. Song Theme / Concept <span class="text-red-400">*</span></label>
                    <input type="text" id="songThemeCustom" placeholder="e.g., Rediscovering old memories, A journey through a futuristic city">
                </div>

                <div class="input-group mb-4">
                    <label for="targetPlatformCustom">2. Target Platform <span class="text-red-400">*</span></label>
                    <select id="targetPlatformCustom" class="w-full">
                        <option value="suno">Suno AI</option>
                        <option value="general">General Lyrics</option>
                    </select>
                </div>

                <div class="input-group mb-4">
                    <label for="musicalStyleCustom">3. Musical Style / Genre <span class="text-red-400">*</span></label>
                    <select id="musicalStyleCustom" class="w-full">
                        <option value="">Select a genre</option>
                        <option value="Pop">Pop</option>
                        <option value="Rock">Rock</option>
                        <option value="Hip Hop">Hip Hop</option>
                        <option value="R&B">R&B</soption>
                        <option value="Electronic">Electronic</option>
                        <option value="Country">Country</option>
                        <option value="Folk">Folk</option>
                        <option value="Jazz">Jazz</option>
                        <option value="Classical">Classical</soption>
                        <option value="Blues">Blues</option>
                        <option value="Indie">Indie</option>
                        <option value="Alternative">Alternative</option>
                        <option value="Lo-fi">Lo-fi</soption>
                        <option value="Metal">Metal</soption>
                        <option value="Reggae">Reggae</option>
                        <option value="Other">Other...</option>
                    </select>
                    <input type="text" id="musicalStyleOtherCustom" class="mt-2 w-full hidden" placeholder="Enter custom genre">
                </div>

                <div class="input-group mb-4">
                    <label for="toneMoodCustom">4. Tone / Mood <span class="text-red-400">*</span></label>
                    <select id="toneMoodCustom" class="w-full">
                        <option value="">Select a tone/mood</soption>
                        <option value="Melancholic">Melancholic</option>
                        <option value="Uplifting">Uplifting</option>
                        <option value="Reflective">Reflective</option>
                        <option value="Energetic">Energetic</option>
                        <option value="Calm">Calm</soption>
                        <option value="Mysterious">Mysterious</option>
                        <option value="Aggressive">Aggressive</option>
                        <option value="Playful">Playful</option>
                        <option value="Romantic">Romantic</option>
                        <option value="Hopeful">Hopeful</option>
                        <option value="Dark">Dark</option>
                        <option value="Other">Other...</option>
                    </select>
                    <input type="text" id="toneMoodOtherCustom" class="mt-2 w-full hidden" placeholder="Enter custom tone/mood">
                </div>

                <div class="input-group mb-4">
                    <label for="songStructureCustom">5. Song Structure (Optional)</label>
                    <input type="text" id="songStructureCustom" placeholder="e.g., Verse-Chorus-Verse-Chorus-Bridge-Chorus-Outro">
                </div>

                <div class="input-group mb-4">
                    <label for="rhymingStyleCustom">6. Rhyming Style (Optional)</label>
                    <select id="rhymingStyleCustom" class="w-full">
                        <option value="">Select a rhyming style</option>
                        <option value="AABB">AABB</option>
                        <option value="ABAB">ABAB</option>
                        <option value="ABCB">ABCB</option>
                        <option value="Free Verse">Free Verse</option>
                        <option value="Slant Rhyme">Slant Rhyme</option>
                        <option value="Internal Rhyme">Internal Rhyme</option>
                        <option value="Other">Other...</option>
                    </select>
                    <input type="text" id="rhymingStyleOtherCustom" class="mt-2 w-full hidden" placeholder="Enter custom rhyming style">
                </div>

                <div class="input-group mb-6">
                    <label for="otherIdeasCustom">7. Other Ideas / Constraints (Optional)</label>
                    <textarea id="otherIdeasCustom" rows="4" placeholder="e.g., Focus on imagery related to water, Include a subtle political message"></textarea>
                </div>

                <div id="errorMessageCustom" class="error-message"></div>

                <button id="generateButtonCustom" class="w-full">
                    <span>Generate Lyrics</span>
                    <div class="loading-spinner"></div>
                </button>
                <button id="backToSimpleModeButton" class="w-full mt-4 bg-gray-600 hover:bg-gray-700">Back to Simple Mode</button>
            </div>
        </div>

        <div class="output-section" id="outputSection">
            <h3 class="text-2xl font-bold text-white mb-4">Generated Lyrics</h3>
            <textarea id="generatedLyrics" readonly class="w-full"></textarea>
            <button id="copyButton" class="w-full mt-4">Copy to Clipboard</button>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const heroSection = document.getElementById('heroSection');
        const appCard = document.getElementById('appCard');
        const formWrapper = document.getElementById('formWrapper');
        const simpleModeSection = document.getElementById('simpleModeSection');
        const customModeSection = document.getElementById('customModeSection');

        // Simple Mode Inputs
        const songThemeSimple = document.getElementById('songThemeSimple');
        const targetPlatformSimple = document.getElementById('targetPlatformSimple');
        const musicalStyleSimple = document.getElementById('musicalStyleSimple');
        const musicalStyleOtherSimple = document.getElementById('musicalStyleOtherSimple');
        const toneMoodSimple = document.getElementById('toneMoodSimple');
        const toneMoodOtherSimple = document.getElementById('toneMoodOtherSimple');
        const generateButtonSimple = document.getElementById('generateButtonSimple');
        const errorMessageSimple = document.getElementById('errorMessageSimple');
        const goToCustomModeButton = document.getElementById('goToCustomModeButton');

        // Custom Mode Inputs
        const songThemeCustom = document.getElementById('songThemeCustom');
        const targetPlatformCustom = document.getElementById('targetPlatformCustom');
        const musicalStyleCustom = document.getElementById('musicalStyleCustom');
        const musicalStyleOtherCustom = document.getElementById('musicalStyleOtherCustom');
        const toneMoodCustom = document.getElementById('toneMoodCustom');
        const toneMoodOtherCustom = document.getElementById('toneMoodOtherCustom');
        const songStructureCustom = document.getElementById('songStructureCustom');
        const rhymingStyleCustom = document.getElementById('rhymingStyleCustom');
        const rhymingStyleOtherCustom = document.getElementById('rhymingStyleOtherCustom');
        const otherIdeasCustom = document.getElementById('otherIdeasCustom');
        const generateButtonCustom = document.getElementById('generateButtonCustom');
        const errorMessageCustom = document.getElementById('errorMessageCustom');
        const backToSimpleModeButton = document.getElementById('backToSimpleModeButton');

        // Output Section
        const outputSection = document.getElementById('outputSection');
        const generatedLyricsTextarea = document.getElementById('generatedLyrics');
        const copyButton = document.getElementById('copyButton');

        // Predefined options for randomization
        const defaultRhymingStyles = ["ABAB", "ABCB", "Free Verse", "Slant Rhyme", "Internal Rhyme"]; // Excludes AABB
        const defaultSongStructures = ["Verse-Chorus-Verse-Chorus-Bridge-Chorus-Outro", "Verse-Verse-Bridge-Chorus-Outro", "Chorus-Verse-Chorus-Verse-Bridge-Outro"];

        // Initial GSAP Animations for hero section and app card
        gsap.from(heroSection, { duration: 1.2, opacity: 0, y: 20, ease: "power3.out" });
        gsap.from(appCard, { duration: 1.2, opacity: 0, y: 20, ease: "power3.out", delay: 0.4 });
        gsap.from(".input-group", { duration: 0.9, y: 20, opacity: 0, stagger: 0.12, ease: "back.out(1.2)", delay: 0.7 });
        gsap.from("#generateButtonSimple, #goToCustomModeButton", { duration: 0.9, y: 20, opacity: 0, ease: "back.out(1.2)", delay: 1.0 });


        /**
         * Toggles the visibility of an "Other" input field based on dropdown selection.
         * @param {HTMLSelectElement} selectElement - The dropdown select element.
         * @param {HTMLInputElement} otherInputElement - The "Other" text input element.
         */
        function toggleOtherInputField(selectElement, otherInputElement) {
            if (selectElement.value === 'Other') {
                gsap.to(otherInputElement, { duration: 0.4, height: "auto", opacity: 1, display: "block", ease: "power2.out" });
            } else {
                gsap.to(otherInputElement, { duration: 0.4, height: 0, opacity: 0, display: "none", ease: "power2.out", onComplete: () => {
                    otherInputElement.value = ''; // Clear the input when hidden
                }});
            }
        }

        // Add event listeners for dropdowns to toggle "Other" input fields for both modes
        musicalStyleSimple.addEventListener('change', () => toggleOtherInputField(musicalStyleSimple, musicalStyleOtherSimple));
        toneMoodSimple.addEventListener('change', () => toggleOtherInputField(toneMoodSimple, toneMoodOtherSimple));

        musicalStyleCustom.addEventListener('change', () => toggleOtherInputField(musicalStyleCustom, musicalStyleOtherCustom));
        toneMoodCustom.addEventListener('change', () => toggleOtherInputField(toneMoodCustom, toneMoodOtherCustom));
        rhymingStyleCustom.addEventListener('change', () => toggleOtherInputField(rhymingStyleCustom, rhymingStyleOtherCustom));

        /**
         * Displays an error message to the user for the current active mode.
         * @param {string} message - The error message to display.
         * @param {string} mode - 'simple' or 'custom'
         */
        function displayError(message, mode) {
            const errorMessageDiv = mode === 'simple' ? errorMessageSimple : errorMessageCustom;
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
            gsap.fromTo(errorMessageDiv, { opacity: 0, y: -10, scale: 0.8 }, { opacity: 1, y: 0, scale: 1, duration: 0.4, ease: "back.out(1.7)" });
        }

        /**
         * Clears any displayed error messages for the current active mode.
         * @param {string} mode - 'simple' or 'custom'
         */
        function clearError(mode) {
            const errorMessageDiv = mode === 'simple' ? errorMessageSimple : errorMessageCustom;
            gsap.to(errorMessageDiv, { opacity: 0, y: -10, scale: 0.8, duration: 0.3, ease: "power2.in", onComplete: () => {
                errorMessageDiv.style.display = 'none';
                errorMessageDiv.textContent = '';
            }});
        }

        /**
         * Gets a random element from an array.
         * @param {Array} arr - The array to pick from.
         * @returns {*} A random element from the array.
         */
        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Handles the transition to Simple Mode.
         */
        function showSimpleMode() {
            gsap.timeline()
                .to(customModeSection, {
                    x: '100%',
                    rotationY: -90,
                    opacity: 0,
                    duration: 0.6,
                    ease: "power2.inOut",
                    onComplete: () => {
                        customModeSection.style.pointerEvents = 'none';
                        simpleModeSection.style.pointerEvents = 'auto';
                        customModeSection.style.display = 'none'; /* Hide after transition */
                    }
                })
                .fromTo(simpleModeSection,
                    { x: '-100%', rotationY: 90, opacity: 0, display: 'flex' }, /* Start off-screen, rotated */
                    { x: '0%', rotationY: 0, opacity: 1, duration: 0.6, ease: "power2.inOut", delay: -0.3 } /* Overlap transition */
                );

            // Adjust formWrapper height dynamically
            gsap.to(formWrapper, { height: simpleModeSection.offsetHeight + 'px', duration: 0.6, delay: 0.2, ease: "power2.inOut" });
        }

        /**
         * Handles the transition to Custom Mode.
         * Copies current simple mode values to custom mode inputs.
         */
        function showCustomMode() {
            // Copy values from simple to custom inputs before animating
            songThemeCustom.value = songThemeSimple.value;
            targetPlatformCustom.value = targetPlatformSimple.value;
            musicalStyleCustom.value = musicalStyleSimple.value;
            musicalStyleOtherCustom.value = musicalStyleOtherSimple.value;
            toneMoodCustom.value = toneMoodSimple.value;
            toneMoodOtherCustom.value = toneMoodOtherSimple.value;

            // Ensure 'Other' fields are displayed/hidden correctly after copying
            toggleOtherInputField(musicalStyleCustom, musicalStyleOtherCustom);
            toggleOtherInputField(toneMoodCustom, toneMoodOtherCustom);

            gsap.timeline()
                .to(simpleModeSection, {
                    x: '-100%',
                    rotationY: 90,
                    opacity: 0,
                    duration: 0.6,
                    ease: "power2.inOut",
                    onComplete: () => {
                        simpleModeSection.style.pointerEvents = 'none';
                        customModeSection.style.pointerEvents = 'auto';
                        simpleModeSection.style.display = 'none'; /* Hide after transition */
                    }
                })
                .fromTo(customModeSection,
                    { x: '100%', rotationY: -90, opacity: 0, display: 'flex' }, /* Start off-screen, rotated */
                    { x: '0%', rotationY: 0, opacity: 1, duration: 0.6, ease: "power2.inOut", delay: -0.3 } /* Overlap transition */
                );

            // Adjust formWrapper height dynamically
            gsap.to(formWrapper, { height: customModeSection.offsetHeight + 'px', duration: 0.6, delay: 0.2, ease: "power2.inOut" });
        }

        // Set initial formWrapper height based on simple mode
        window.addEventListener('load', () => {
             // Use a small delay to ensure initial render calculations are complete
             setTimeout(() => {
                formWrapper.style.height = simpleModeSection.offsetHeight + 'px';
             }, 100); // 100ms delay to allow DOM to fully render

             // Initial setup for output section visibility on load
             if (window.innerWidth >= 768) {
                outputSection.style.display = 'flex';
                outputSection.style.opacity = 1;
            }
        });
        window.addEventListener('resize', () => {
            // Recalculate height on resize for responsive layouts
            // Use a small delay to ensure layout recalculations are complete
            setTimeout(() => {
                if (simpleModeSection.style.transform === 'translateX(0%)' || simpleModeSection.style.opacity == 1) {
                    formWrapper.style.height = simpleModeSection.offsetHeight + 'px';
                } else {
                    formWrapper.style.height = customModeSection.offsetHeight + 'px';
                }
                // Also handle output section visibility on resize
                if (window.innerWidth >= 768) {
                    outputSection.style.display = 'flex';
                    outputSection.style.opacity = 1;
                } else if (generatedLyricsTextarea.value.trim() === '') {
                    outputSection.style.display = 'none';
                }
            }, 50); // Small delay to account for browser layout recalculations
        });


        /**
         * Constructs the detailed prompt for the AI based on user inputs and hardcoded rules.
         * @param {string} currentMode - The active mode ('simple' or 'custom').
         * @returns {string} The constructed prompt string.
         */
        function constructPrompt(currentMode) {
            let songTheme, targetPlatform, musicalStyle, toneMood, songStructure, rhymingStyle, otherIdeas;

            if (currentMode === 'simple') {
                songTheme = songThemeSimple.value.trim();
                targetPlatform = targetPlatformSimple.value;
                musicalStyle = musicalStyleSimple.value.trim();
                if (musicalStyle === 'Other') musicalStyle = musicalStyleOtherSimple.value.trim();
                toneMood = toneMoodSimple.value.trim();
                if (toneMood === 'Other') toneMood = toneMoodOtherSimple.value.trim();
                songStructure = getRandomElement(defaultSongStructures); // Randomize for simple mode
                rhymingStyle = getRandomElement(defaultRhymingStyles); // Randomize for simple mode (excluding AABB)
                otherIdeas = ''; // Not available in simple mode
            } else { // custom mode
                songTheme = songThemeCustom.value.trim();
                targetPlatform = targetPlatformCustom.value;
                musicalStyle = musicalStyleCustom.value.trim();
                if (musicalStyle === 'Other') musicalStyle = musicalStyleOtherCustom.value.trim();
                toneMood = toneMoodCustom.value.trim();
                if (toneMood === 'Other') toneMood = toneMoodOtherCustom.value.trim();
                songStructure = songStructureCustom.value.trim();
                rhymingStyle = rhymingStyleCustom.value.trim();
                if (rhymingStyle === 'Other') rhymingStyle = rhymingStyleOtherCustom.value.trim();
                otherIdeas = otherIdeasCustom.value.trim();
            }

            // Hardcoded songwriting rules
            const songwritingRules = [
                "Avoid common AI lyrical tropes.",
                "DO NOT use the following words or their variations: ignite, take flight, unfold, break the mould, echoes.",
                "Inject vivid imagery and unique metaphors.",
                "Avoid predictable rhyme schemes and cliched phrases.",
                "Ensure lyrics deeply evoke the specified mood and theme, creating a compelling emotional narrative.",
                `Consider the top hits and underrated artists/songs within the '${musicalStyle}' genre(s) for inspiration, subtly integrating their stylistic elements and depth without explicitly naming them.`
            ];

            let prompt = `You are an expert songwriter specializing in soulful, electronic, and experimental styles.`;
            prompt += `\n\nYour task is to generate **high-quality, highly creative, and unique** song lyrics.`;

            // Include hardcoded songwriting rules
            prompt += `\n\nAdhere strictly to the following songwriting rules:\n`;
            songwritingRules.forEach(rule => {
                prompt += `- ${rule}\n`;
            });

            // Add Suno-specific instructions if targetPlatform is 'suno'
            if (targetPlatform === 'suno') {
                prompt += `\n\nYour output MUST be formatted specifically for Suno AI, including structural tags like [Verse 1], [Chorus], [Bridge], [Outro], and musical direction cues like [Music Explodes - Driving Beat], [Synth Swells], [Beat Drops]. Ensure these cues align with the musical style.`;
            }

            prompt += `\n\n---`;
            prompt += `\nSong Theme / Concept: ${songTheme}`;
            prompt += `\nMusical Style / Genre: ${musicalStyle}`;
            prompt += `\nTone / Mood: ${toneMood} (Ensure the lyrics strongly convey this specific emotion throughout.)`;

            if (songStructure) {
                prompt += `\nSong Structure: ${songStructure}`;
            }
            if (rhymingStyle) {
                prompt += `\nRhyming Style: ${rhymingStyle}`;
            }
            if (otherIdeas) {
                prompt += `\nOther Ideas / Constraints: ${otherIdeas}`;
            }
            prompt += `\n---`;

            prompt += `\n\nOutput ONLY the song lyrics. Do not include any introductory or concluding text, or any conversational remarks.`;

            if (targetPlatform === 'suno') {
                prompt += `\n\nGenerate the lyrics in Suno AI format, focusing on fresh, evocative language:`;
            } else {
                prompt += `\n\nGenerate the lyrics, focusing on fresh, evocative language:`;
            }

            return prompt;
        }

        /**
         * Handles the "Generate Lyrics" button click event for either mode.
         * @param {string} currentMode - The active mode ('simple' or 'custom').
         */
        async function handleGenerateLyrics(currentMode) {
            clearError(currentMode);

            let songThemeInputRef, targetPlatformSelectRef, musicalStyleSelectRef, musicalStyleOtherRef, toneMoodSelectRef, toneMoodOtherRef, generateButtonRef, errorMessageRef;

            if (currentMode === 'simple') {
                songThemeInputRef = songThemeSimple;
                targetPlatformSelectRef = targetPlatformSimple;
                musicalStyleSelectRef = musicalStyleSimple;
                musicalStyleOtherRef = musicalStyleOtherSimple;
                toneMoodSelectRef = toneMoodSimple;
                toneMoodOtherRef = toneMoodOtherSimple;
                generateButtonRef = generateButtonSimple;
                errorMessageRef = errorMessageSimple;
            } else { // custom mode
                songThemeInputRef = songThemeCustom;
                targetPlatformSelectRef = targetPlatformCustom;
                musicalStyleSelectRef = musicalStyleCustom;
                musicalStyleOtherRef = musicalStyleOtherCustom;
                toneMoodSelectRef = toneMoodCustom;
                toneMoodOtherRef = toneMoodOtherCustom;
                generateButtonRef = generateButtonCustom;
                errorMessageRef = errorMessageCustom;
            }

            const requiredFields = [
                { name: 'Song Theme / Concept', element: songThemeInputRef },
                { name: 'Target Platform', element: targetPlatformSelectRef },
                { name: 'Musical Style / Genre', element: musicalStyleSelectRef },
                { name: 'Tone / Mood', element: toneMoodSelectRef }
            ];

            let allFieldsFilled = true;
            for (const field of requiredFields) {
                let value;
                if (field.element.tagName === 'SELECT') {
                    value = field.element.value;
                    if (value === "") {
                        displayError(`Please select an option for '${field.name}'.`, currentMode);
                        allFieldsFilled = false;
                        gsap.to(field.element, { duration: 0.2, x: -5, yoyo: true, repeat: 3, ease: "power1.inOut", borderBottomColor: "#fc8181" });
                        break;
                    }
                    if (value === 'Other') {
                        let otherInput;
                        if (field.name === 'Musical Style / Genre') otherInput = (currentMode === 'simple' ? musicalStyleOtherSimple : musicalStyleOtherCustom);
                        else if (field.name === 'Tone / Mood') otherInput = (currentMode === 'simple' ? toneMoodOtherSimple : toneMoodOtherCustom);
                        else if (field.name === 'Rhyming Style') otherInput = rhymingStyleOtherCustom; // Only in custom mode
                        else continue;

                        if (!otherInput || !otherInput.value.trim()) {
                            displayError(`Please enter a custom value for '${field.name}'.`, currentMode);
                            allFieldsFilled = false;
                            gsap.to(otherInput, { duration: 0.2, x: -5, yoyo: true, repeat: 3, ease: "power1.inOut", borderBottomColor: "#fc8181" });
                            break;
                        }
                    }
                } else {
                    value = field.element.value.trim();
                    if (!value) {
                        displayError(`Please fill in the '${field.name}' field.`, currentMode);
                        allFieldsFilled = false;
                        gsap.to(field.element, { duration: 0.2, x: -5, yoyo: true, repeat: 3, ease: "power1.inOut", borderBottomColor: "#fc8181" });
                        break;
                    }
                }
            }

            if (!allFieldsFilled) {
                return;
            }

            // Animate button for loading state
            const buttonTextSpan = generateButtonRef.querySelector('span');
            const buttonSpinner = generateButtonRef.querySelector('.loading-spinner');

            generateButtonRef.disabled = true;
            // GSAP timeline for button loading animation
            const loadingTimeline = gsap.timeline({ repeat: -1, yoyo: true });
            loadingTimeline.to(generateButtonRef, { duration: 0.3, backgroundColor: "#4a5568", boxShadow: "none", scale: 1.02, ease: "power2.inOut" })
                           .to(buttonTextSpan, { duration: 0.3, opacity: 0, x: -10, ease: "power2.inOut", onComplete: () => {
                                buttonTextSpan.style.display = 'none';
                                buttonTextSpan.textContent = 'Generating...';
                            }}, 0)
                           .to(buttonSpinner, { duration: 0.3, opacity: 1, scale: 1, display: 'block', ease: "power2.inOut" }, 0.1);


            try {
                const prompt = constructPrompt(currentMode);
                console.log("Constructed Prompt:\n", prompt);

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    generatedLyricsTextarea.value = text;
                } else {
                    console.error("Gemini API returned an unexpected response structure:", result);
                    displayError("Failed to generate lyrics. Please try again. Check console for details.", currentMode);
                }

                if (outputSection.style.display === 'none' || outputSection.style.display === '') {
                    outputSection.style.display = 'flex';
                    gsap.fromTo(outputSection, { opacity: 0, y: 30, scale: 0.95 }, { opacity: 1, y: 0, scale: 1, duration: 1, ease: "power3.out", delay: 0.2 });
                }
            } catch (error) {
                console.error("Error generating lyrics:", error);
                displayError("An error occurred during lyric generation. Please try again. Check console for network errors.", currentMode);
            } finally {
                // Kill loading timeline and revert button animation
                loadingTimeline.kill(); // Stop the loading animation loop
                gsap.timeline()
                    .to(buttonSpinner, { duration: 0.3, opacity: 0, scale: 0, ease: "power2.inOut", onComplete: () => {
                        buttonSpinner.style.display = 'none';
                    }})
                    .to(buttonTextSpan, { duration: 0.3, opacity: 1, x: 0, ease: "power2.inOut", onStart: () => {
                        buttonTextSpan.style.display = 'block';
                        buttonTextSpan.textContent = 'Generate Lyrics'; // Revert text
                    }}, 0.2) // Start slightly after spinner hides
                    .to(generateButtonRef, { duration: 0.3, background: "linear-gradient(90deg, #667eea, #7f9cf5)", boxShadow: "0 8px 15px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2)", scale: 1, ease: "power2.inOut" }, 0.2);
                generateButtonRef.disabled = false;
            }
        }

        /**
         * Copies the generated lyrics to the clipboard.
         */
        function handleCopyLyrics() {
            generatedLyricsTextarea.select();
            try {
                document.execCommand('copy');
                const originalText = copyButton.textContent;
                copyButton.textContent = 'Copied!';
                gsap.to(copyButton, { duration: 0.2, backgroundColor: "#48bb78", ease: "power2.inOut", onComplete: () => {
                    gsap.to(copyButton, { duration: 0.8, backgroundColor: "#667eea", delay: 1, ease: "power2.out", onComplete: () => {
                        copyButton.textContent = originalText;
                    }});
                }});
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
        }

        // Event Listeners
        generateButtonSimple.addEventListener('click', () => handleGenerateLyrics('simple'));
        generateButtonCustom.addEventListener('click', () => handleGenerateLyrics('custom'));
        copyButton.addEventListener('click', handleCopyLyrics);
        goToCustomModeButton.addEventListener('click', showCustomMode);
        backToSimpleModeButton.addEventListener('click', showSimpleMode);

        // Initial setup for form wrapper height and output section visibility
        window.addEventListener('load', () => {
            // Use a small delay to ensure initial render calculations are complete
            setTimeout(() => {
                formWrapper.style.height = simpleModeSection.offsetHeight + 'px';
            }, 100); // 100ms delay to allow DOM to fully render

            if (window.innerWidth >= 768) {
                outputSection.style.display = 'flex';
                outputSection.style.opacity = 1;
            }
        });

        // Recalculate height on resize for responsive layouts
        window.addEventListener('resize', () => {
            setTimeout(() => {
                if (simpleModeSection.style.transform === 'translateX(0%)' || simpleModeSection.style.opacity == 1) {
                    formWrapper.style.height = simpleModeSection.offsetHeight + 'px';
                } else {
                    formWrapper.style.height = customModeSection.offsetHeight + 'px';
                }
                // Also handle output section visibility on resize
                if (window.innerWidth >= 768) {
                    outputSection.style.display = 'flex';
                    outputSection.style.opacity = 1;
                } else if (generatedLyricsTextarea.value.trim() === '') {
                    outputSection.style.display = 'none';
                }
            }, 50); // Small delay to account for browser layout recalculations
        });

    </script>
</body>
</html>
